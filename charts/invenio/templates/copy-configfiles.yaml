{{- $mounted := .Values.invenio.mountedDir }}
{{- $rendered := .Values.invenio.configDir }}
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: {{ include "invenio.fullname" . }}-copy-configfiles
  labels:
    {{- include "invenio.labels" . | nindent 4 }}
    app: {{ .Values.invenio.remote_apps.secret_name }}
  annotations:
    helm.sh/resource-policy: keep
stringData:
  copy.sh: |-
    cd {{ $mounted }}
    {{- if ternary .Values.postgresql.auth.password .Values.postgresqlExternal.password .Values.postgresql.enabled }}
    # postgres password from Values
    {{ printf "INVENIO_DB_PASSWORD=$(cat INVENIO_DB_PASSWORD)" }}
    {{- else }}
    # postgres password from secret
    {{ printf "INVENIO_DB_PASSWORD=$(cat %s)" (ternary .Values.postgresql.auth.secretKeys.userPasswordKey .Values.postgresqlExternal.existingSecretPasswordKey .Values.postgresql.enabled) }}
    {{- end }}
    {{ printf "INVENIO_DB_USER=$(cat INVENIO_DB_USER)" }}
    {{ printf "INVENIO_DB_HOST=$(cat INVENIO_DB_HOST)" }}
    {{ printf "INVENIO_DB_PORT=$(cat INVENIO_DB_PORT)" }}
    {{ printf "INVENIO_DB_NAME=$(cat INVENIO_DB_NAME)" }}
    {{ printf "INVENIO_DB_PROTOCOL=$(cat INVENIO_DB_PROTOCOL)" }}
    {{ printf "echo INVENIO_SQLALCHEMY_DATABASE_URI: \\\"${INVENIO_DB_PROTOCOL}://${INVENIO_DB_USER}:${INVENIO_DB_PASSWORD}@${INVENIO_DB_HOST}:${INVENIO_DB_PORT}/${INVENIO_DB_NAME}\\\" >  %s/INVENIO_SQLALCHEMY_DATABASE_URI.yaml" $rendered }}
    # rabbitmq settings
    {{- if  ternary .Values.rabbitmq.auth.password .Values.rabbitmqExternal.password .Values.rabbitmq.enabled  }}
    # rabbitmq password from values
    {{ printf "INVENIO_AMQP_BROKER_PASSWORD=$(cat INVENIO_AMQP_BROKER_PASSWORD)" }}
    {{- else }}
    # rabbitmq password from secret
    {{ printf "INVENIO_AMQP_BROKER_PASSWORD=$(cat %s)" (include "invenio.rabbitmq.secretKey" .  | trim) }}
    {{- end }}
    {{ printf "INVENIO_AMQP_BROKER_USER=$(cat INVENIO_AMQP_BROKER_USER)" }}
    {{ printf "INVENIO_AMQP_BROKER_HOST=$(cat INVENIO_AMQP_BROKER_HOST)" }}
    {{ printf "INVENIO_AMQP_BROKER_PORT=$(cat INVENIO_AMQP_BROKER_PORT)" }}
    {{ printf "INVENIO_AMQP_BROKER_VHOST=$(cat INVENIO_AMQP_BROKER_VHOST | sed 's_/__g')" }}
    {{ printf "INVENIO_AMQP_BROKER_PROTOCOL=$(cat INVENIO_AMQP_BROKER_PROTOCOL)" }}
    {{ printf "echo INVENIO_CELERY_BROKER_URL: \\\"${INVENIO_AMQP_BROKER_PROTOCOL}://${INVENIO_AMQP_BROKER_USER}:${INVENIO_AMQP_BROKER_PASSWORD}@${INVENIO_AMQP_BROKER_HOST}:${INVENIO_AMQP_BROKER_PORT}/${INVENIO_AMQP_BROKER_VHOST}\\\" >  %s/INVENIO_CELERY_BROKER_URL.yaml" $rendered }}
    {{ printf "echo INVENIO_BROKER_URL: \\\"${INVENIO_AMQP_BROKER_PROTOCOL}://${INVENIO_AMQP_BROKER_USER}:${INVENIO_AMQP_BROKER_PASSWORD}@${INVENIO_AMQP_BROKER_HOST}:${INVENIO_AMQP_BROKER_PORT}/${INVENIO_AMQP_BROKER_VHOST}\\\" >  %s/INVENIO_BROKER_URL.yaml" $rendered }}
